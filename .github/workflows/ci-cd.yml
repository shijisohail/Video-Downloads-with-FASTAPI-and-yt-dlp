name: CI CD Pipeline

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment'

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
    - name: Show deployment info
      run: |
        echo "🔧 Deployment triggered by: ${{ github.event_name }}"
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "📝 Reason: ${{ github.event.inputs.reason }}"
          echo "🌍 Environment: ${{ github.event.inputs.environment }}"
        fi
        echo "👤 Triggered by: ${{ github.actor }}"
        echo "🌟 Branch: ${{ github.ref_name }}"
        
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "🚀 Starting deployment..."
          
          # Go to project directory
          cd /home/ubuntu/Video-Downloads-with-FASTAPI-and-yt-dlp
          
          # Pull latest changes
          echo "📥 Pulling latest code..."
          git pull origin master
          
          # Stop existing container
          echo "🛑 Stopping container..."
          docker stop video-api || echo "No container to stop"
          docker rm video-api || echo "No container to remove"
          
          # Build new image
          echo "🔨 Building Docker image..."
          docker build -t video-api .
          
          # Run new container
          echo "🚀 Starting container..."
          docker run -d \
            --name video-api \
            --restart unless-stopped \
            -p 8888:8888 \
            -v $(pwd)/downloaded_videos:/app/downloaded_videos \
            -v $(pwd)/logs:/app/logs \
            -v $(pwd)/cookies:/app/cookies \
            video-api
          
          # Wait and check
          echo "⏳ Waiting for app to start..."
          sleep 30
          
          # Health check
          if curl -f http://localhost:8888/api/v1/health; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Health check failed!"
            exit 1
          fi
