name: Deploy to Server

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment'

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "🚀 Starting deployment - ${{ github.event.inputs.reason || 'Auto deployment' }}"
          
          # Navigate to repository
          cd /home/ubuntu/Video-Downloads-with-FASTAPI-and-yt-dlp
          
          # Pull latest changes from GitHub
          echo "📥 Pulling latest code from GitHub..."
          git pull origin master
          
          # Stop and remove existing containers using Makefile
          echo "🛑 Stopping and cleaning containers..."
          make docker-stop
          make docker-clean
          
          # Build and run new container using Makefile
          echo "🚀 Building and running new container..."
          make docker-run
          
          # Health check
          echo "⏳ Performing health check..."
          sleep 30
          curl -f http://localhost:8888/api/v1/health && echo "✅ Deployment successful!" || { echo "❌ Health check failed!"; exit 1; }
